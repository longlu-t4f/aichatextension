(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&t(i)}).observe(document,{childList:!0,subtree:!0});function r(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(o){if(o.ep)return;o.ep=!0;const s=r(o);fetch(o.href,s)}})();const h="ai-chat-iframe-bridge",_="AI_CHAT_IFRAME_READY",E="AI_CHAT_HOST_READY",v="AI_CHAT_PREFILL_REQUEST",A="AI_CHAT_PREFILL_EVENT",C="AI_CHAT_OPEN_OPTIONS";function O(e){return typeof e=="object"&&e!==null&&"channel"in e&&e.channel===h&&"type"in e&&typeof e.type=="string"}function x(e){return e.type===E||e.type===A}const I="https://api.openai.com",N="gpt-4o-mini";async function P(e,n={}){const{method:r="GET",headers:t={},body:o,signal:s}=n,i=`${I}/${e.replace(/^\//,"")}`,w={"Content-Type":"application/json",...t},a=await fetch(i,{method:r,headers:w,body:o==null?void 0:JSON.stringify(o),signal:s}),c=(a.headers.get("content-type")||"").includes("application/json")?await a.json():await a.text();if(!a.ok){const L=typeof c=="string"?c:c?.error?.message||c?.message||`请求失败（${a.status}）`;throw new Error(L)}return c}async function H(e,n={}){if(!e.trim())throw new Error("输入内容不能为空");const t=await P("v1/chat/completions",{method:"POST",body:{model:N,messages:[{role:"system",content:"你是有帮助的助手。"},{role:"user",content:e}]},signal:n.signal});return{text:t?.choices?.[0]?.message?.content??(typeof t=="string"?t:JSON.stringify(t,null,2)),raw:t}}async function R(e){try{await navigator.clipboard.writeText(e)}catch{const n=document.createElement("textarea");n.value=e,n.setAttribute("readonly",""),n.style.position="fixed",n.style.left="-10000px",n.style.top="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),n.remove()}}const p=e=>document.querySelector(e),l=p("#input"),m=p("#send"),T=p("#messages"),S=p("#open-settings");let d=null,b=!1,u=!1;S?.addEventListener("click",()=>{g(C)});m.addEventListener("click",()=>{y()});l.addEventListener("keydown",e=>{(e.metaKey||e.ctrlKey)&&e.key==="Enter"&&(e.preventDefault(),y())});window.addEventListener("message",e=>{e.source===window.parent&&(!O(e.data)||!x(e.data)||d&&e.origin!==d||(d=e.origin,M(e.data)))});g(_,{source:"remote-ui"});function M(e){switch(e.type){case E:b=!0,D();break;case A:F(e.payload?.text??"",e.payload?.autoSend);break}}function D(){g(v)}async function y(){if(u)return;const e=l.value.trim();if(!e)return;if(!b){f("assistant","扩展宿主尚未连接，请稍后重试。");return}l.value="",f("user",e),u=!0,m.disabled=!0;const n=new AbortController,r=f("assistant","正在生成…");try{const{text:t}=await H(e,{signal:n.signal});r.setText(t)}catch(t){if(t instanceof DOMException&&t.name==="AbortError")r.setText("请求已取消");else{const o=t instanceof Error?t.message:String(t);r.setText(`请求失败：${o}`)}}finally{u=!1,m.disabled=!1,l.focus()}}function F(e,n){l.value=e??"",n&&e?.trim()&&!u&&y()}function f(e,n){const r=document.createElement("div");r.classList.add("message",e==="user"?"message-user":"message-ai");const t=document.createElement("div");t.className="message-bubble",t.textContent=n,r.appendChild(t);const o=document.createElement("div");o.className="message-actions";const s=document.createElement("button");return s.type="button",s.className="message-action",s.setAttribute("aria-label","复制"),s.title="复制",s.innerHTML='<svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none"><path stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M8.25 5.25v-.75A2.25 2.25 0 0 1 10.5 2.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25h-.75m-6 3h-9A2.25 2.25 0 0 1 1.5 16.5v-9A2.25 2.25 0 0 1 3.75 5.25h9A2.25 2.25 0 0 1 15 7.5v9a2.25 2.25 0 0 1-2.25 2.25Z"/></svg>',s.addEventListener("click",async()=>{await R(t.textContent??"")}),o.appendChild(s),r.appendChild(o),T.appendChild(r),B(),{wrapper:r,bubble:t,setText(i){t.textContent=i}}}function B(){const e=T;requestAnimationFrame(()=>e.scrollTo({top:e.scrollHeight,behavior:"smooth"}))}function g(e,n){const r={channel:h,type:e,payload:n},t=d??"*";window.parent.postMessage(r,t)}
