const G="MSG_PREFILL",B="[AI-Reply-Bubble]";let l=null,x="",u=!1,a=null,h=null,m=null;function T(){h!=null&&(window.clearTimeout(h),h=null)}function p(t,e){e===void 0?console.debug(B,t):console.debug(B,t,e)}function v(t){return t.button===0||t.pointerType==="touch"||t.pointerType==="pen"}function N(t){const e=t.trim();if(!e)return;const n={type:G,text:e,autoSend:!1};chrome.runtime.sendMessage(n).then(()=>{},()=>{})}function H(){if(l)return l;l=document.createElement("div"),l.className="ai-chat-sidebar-bubble";const t=document.createElement("img");t.src=chrome.runtime.getURL("content/logo.png"),t.alt="AI",t.className="ai-chat-sidebar-bubble-icon";const e=document.createElement("span");return e.textContent="AI 建议回复",e.className="ai-chat-sidebar-bubble-text",l.appendChild(t),l.appendChild(e),l.addEventListener("mousedown",n=>{n.preventDefault(),n.stopPropagation()}),l.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const o=x||R()?.text;o&&(N(o),M("bubble-click"))}),document.documentElement.appendChild(l),l}function D(){const t=document.documentElement;if(!t)return{scaleX:1,scaleY:1,translateX:0,translateY:0};const e=document.createElement("div");e.style.setProperty("all","initial"),e.style.position="fixed",e.style.left="0px",e.style.top="0px",e.style.width="0",e.style.height="0",e.style.opacity="0",e.style.pointerEvents="none",e.style.zIndex="-1",t.appendChild(e);const n=e.getBoundingClientRect();e.style.left="100px";const o=e.getBoundingClientRect();e.style.left="0px",e.style.top="100px";const s=e.getBoundingClientRect();e.remove();const i=o.left-n.left,c=s.top-n.top;return{scaleX:Math.abs(i)<1e-4?1:i/100,scaleY:Math.abs(c)<1e-4?1:c/100,translateX:n.left,translateY:n.top}}function k(t,e,n){const o=Math.abs(n.scaleX)<1e-4?1:n.scaleX,s=Math.abs(n.scaleY)<1e-4?1:n.scaleY;return{left:(t-n.translateX)/o,top:(e-n.translateY)/s}}function R(){const t=window.getSelection();if(!t||t.rangeCount===0)return null;const e=t.type;if(!(!t.isCollapsed||e==="Range"))return null;const o=t.toString().trim();if(!o)return null;const s=t.getRangeAt(0),i=Array.from(s.getClientRects()).filter(f=>f.width||f.height),c=i[i.length-1]??s.getBoundingClientRect();if(!c)return null;const d=t.anchorNode===s.startContainer&&t.anchorOffset===s.startOffset;return{text:o,rect:c,isForward:d}}function F(t){const e=H();T();const n=D(),o=Math.abs(n.scaleX)<1e-4?1:n.scaleX,s=Math.abs(n.scaleY)<1e-4?1:n.scaleY,i=Math.abs((e.offsetWidth||0)*o),c=Math.abs((e.offsetHeight||0)*s),d=window.visualViewport,f=d?.offsetLeft??0,y=d?.offsetTop??0,A=d?.width??window.innerWidth??document.documentElement.clientWidth??i,C=d?.height??window.innerHeight??document.documentElement.clientHeight??c,r=t.rect,L=Math.abs(r.width)<1&&Math.abs(r.height)<1,_=L?m?.x??r.right:t.isForward?r.right:r.left,I=L?m?.y??r.bottom:r.bottom,Y=_-i,E=f+8,X=f+A-i-8,P=Math.min(Math.max(Y,E),Math.max(E,X)),O=I+8,w=y+8,S=y+C-c-8,U=Math.min(Math.max(O,w),Math.max(w,S)),g=k(P,U,n);e.style.top=`${g.top}px`,e.style.left=`${g.left}px`,e.style.opacity="1",e.style.pointerEvents="auto",e.style.position="fixed",e.style.transform="none",p("浮窗展示",{textLength:t.text.length,layoutTop:g.top,layoutLeft:g.left})}function b({force:t=!1,reason:e="unknown"}={}){p("更新浮窗",{force:t,reason:e,pointerSelecting:u});const n=R();if(!n){M("无有效选区");return}if(x=n.text,!t&&u){p("更新浮窗:等待指针结束");return}a!=null&&(window.clearTimeout(a),a=null);const o=()=>{F(n),a=null};t?o():a=window.setTimeout(o,80)}function M(t="unknown"){l&&(p("浮窗隐藏",{reason:t}),l.style.opacity="0",l.style.pointerEvents="none",a!=null&&(window.clearTimeout(a),a=null),T(),h=window.setTimeout(()=>{l?.remove(),l=null,h=null},200))}function V(t,e){let n=0,o=null;return function(...s){const i=Date.now();i-n>=e?(n=i,t.apply(this,s)):o==null&&(o=window.setTimeout(()=>{n=Date.now(),o=null,t.apply(this,s)},e-(i-n)))}}const W=V(()=>b({force:!1,reason:"selectionchange"}),120);document.addEventListener("selectionchange",W);document.addEventListener("scroll",()=>{b({force:!1,reason:"scroll"})},!0);document.addEventListener("pointerdown",t=>{v(t)&&(u=!0,m={x:t.clientX,y:t.clientY},p("指针按下",{pointerX:t.clientX,pointerY:t.clientY}))});document.addEventListener("pointerup",t=>{v(t)&&(u=!1,m={x:t.clientX,y:t.clientY},b({force:!0,reason:"pointerup"}))},!0);document.addEventListener("pointercancel",()=>{u=!1,m=null,b({force:!1,reason:"pointercancel"})});document.addEventListener("selectstart",()=>{u=!0,p("selectstart")},!0);document.addEventListener("keyup",()=>{u=!1,b({force:!0,reason:"keyup"})});
