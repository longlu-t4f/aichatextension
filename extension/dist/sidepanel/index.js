import{M as O,P as R,i as P,a as T,b as S}from"../assets/messaging-A4bD3-tz.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))d(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&d(s)}).observe(document,{childList:!0,subtree:!0});function A(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function d(t){if(t.ep)return;t.ep=!0;const n=A(t);fetch(t.href,n)}})();const u="ai-chat-iframe-bridge",l="AI_CHAT_IFRAME_READY",b="AI_CHAT_HOST_READY",E="AI_CHAT_PREFILL_REQUEST",M="AI_CHAT_PREFILL_EVENT",p="AI_CHAT_OPEN_OPTIONS";function w(e){return typeof e=="object"&&e!==null&&"channel"in e&&e.channel===u&&"type"in e&&typeof e.type=="string"}function N(e){return e.type===l||e.type===E||e.type===p}const h="http://172.20.62.7:5173/",F=[];function U(e){try{return new URL(e).origin}catch{return}}const D=U(h),f=h,H=Array.from(new Set([...F,D].filter(e=>typeof e=="string"&&e.length>0)));function C(e){try{const r=new URL(f);return e!=null&&r.searchParams.set("tabId",String(e)),r.toString()}catch{return f}}const i=document.getElementById("ai-chat-frame");if(!i)throw new Error("缺少 iframe 容器，无法初始化侧边栏宿主。");let c;chrome.runtime.sendMessage({type:O}).catch(()=>{});chrome.runtime.connect({name:R});function m(){chrome.tabs.query({active:!0,currentWindow:!0}).then(e=>{e[0]?.id&&(c=e[0].id)}).catch(()=>{})}m();chrome.tabs.onActivated.addListener(()=>{m()});const y=C(c);i.src=y;const _=new Set(H),a=W(y);a&&_.add(a);let g=!1,o=null;window.addEventListener("message",e=>{if(e.source!==i.contentWindow||!_.has(e.origin)||!w(e.data)||!N(e.data))return;const r=e.data;v(r)});chrome.runtime.onMessage.addListener(e=>!P(e)||!T(e)?!1:(o=e,I(),!0));function v(e){switch(e.type){case l:g=!0,L({channel:u,type:b,payload:{tabId:c}}),I();break;case E:G();break;case p:chrome.runtime.openOptionsPage().catch(()=>{});break}}function I(){if(!g||!o)return;const{text:e,autoSend:r}=o;L({channel:u,type:M,payload:{text:e,autoSend:r}}),o=null}function L(e){if(!i.contentWindow)return;const r=a??"*";i.contentWindow.postMessage(e,r)}function G(){chrome.runtime.sendMessage({type:S,tabId:c}).catch(()=>{})}function W(e){if(e)try{return new URL(e).origin}catch{return}}
