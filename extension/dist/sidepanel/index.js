import{M as O,P as R,i as P,a as T,b as S}from"../assets/messaging-A4bD3-tz.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))u(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&u(s)}).observe(document,{childList:!0,subtree:!0});function A(t){const r={};return t.integrity&&(r.integrity=t.integrity),t.referrerPolicy&&(r.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?r.credentials="include":t.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function u(t){if(t.ep)return;t.ep=!0;const r=A(t);fetch(t.href,r)}})();const d="ai-chat-iframe-bridge",f="AI_CHAT_IFRAME_READY",b="AI_CHAT_HOST_READY",E="AI_CHAT_PREFILL_REQUEST",M="AI_CHAT_PREFILL_EVENT",h="AI_CHAT_OPEN_OPTIONS";function w(e){return typeof e=="object"&&e!==null&&"channel"in e&&e.channel===d&&"type"in e&&typeof e.type=="string"}function N(e){return e.type===f||e.type===E||e.type===h}const p="http://localhost:5173/",F=[];function U(e){try{return new URL(e).origin}catch{return}}const D=U(p),l=p,H=Array.from(new Set([...F,D].filter(e=>typeof e=="string"&&e.length>0)));function C(e){try{const n=new URL(l);return e!=null&&n.searchParams.set("tabId",String(e)),n.toString()}catch{return l}}const i=document.getElementById("ai-chat-frame");if(!i)throw new Error("缺少 iframe 容器，无法初始化侧边栏宿主。");const v=document.getElementById("host-loading");let c;chrome.runtime.sendMessage({type:O}).catch(()=>{});chrome.runtime.connect({name:R});function m(){chrome.tabs.query({active:!0,currentWindow:!0}).then(e=>{e[0]?.id&&(c=e[0].id)}).catch(()=>{})}m();chrome.tabs.onActivated.addListener(()=>{m()});const g=C(c);i.src=g;const y=new Set(H),a=Y(g);a&&y.add(a);let L=!1,o=null;window.addEventListener("message",e=>{if(e.source!==i.contentWindow||!y.has(e.origin)||!w(e.data)||!N(e.data))return;const n=e.data;G(n)});chrome.runtime.onMessage.addListener(e=>!P(e)||!T(e)?!1:(o=e,_(),!0));function G(e){switch(e.type){case f:L=!0,B(),I({channel:d,type:b,payload:{tabId:c}}),_();break;case E:W();break;case h:chrome.runtime.openOptionsPage().catch(()=>{});break}}function _(){if(!L||!o)return;const{text:e,autoSend:n}=o;I({channel:d,type:M,payload:{text:e,autoSend:n}}),o=null}function I(e){if(!i.contentWindow)return;const n=a??"*";i.contentWindow.postMessage(e,n)}function W(){chrome.runtime.sendMessage({type:S,tabId:c}).catch(()=>{})}function B(){v?.classList.add("hidden")}function Y(e){if(e)try{return new URL(e).origin}catch{return}}
